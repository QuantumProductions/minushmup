<html>
<body bgcolor="#CCCCCC">
</body>
<script src="util.js"></script>
<script>

</script>
<script src="input.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>
<script>
var app = new PIXI.Application(600, 800, {backgroundColor : 0x333333});
document.body.appendChild(app.view);
var p = PIXI.Sprite.fromImage('bunny.png')
p.anchor.set(0.5);
p.x = app.screen.width / 2;
p.y = app.screen.height / 2;
p.mx = 0;
p.my = 0;
p.speed = 4;
app.stage.addChild(p);

var b = PIXI.Sprite.fromImage('bunny.png')
b.anchor.set(0.5);
b.x = p.x + 100;
b.y = p.y - 30;

b.phase = 0;
b.r = 90;
b.power = 4;

app.stage.addChild(b);

function bulletSpeedBonus() {
    if (p.mx == 0 && p.my == 0) {
        return 4;
    }

    return 0;
}

function movePlayer() {
    if (key_down_map['L1'] == true) {
        p.mx = -1;
    } else if (key_down_map['R1'] == true) {
        p.mx = 1;
    } else {
        p.mx = 0;
    }

    if (key_down_map['U1'] == true) {
        p.my = -1;
    } else if (key_down_map['D1'] == true) {
        p.my = 1;
    } else {
        p.my = 0;
    }

    p.x = p.x + p.mx;
    p.x = Math.ceil(p.x, 0);
    p.x = Math.floor(p.x, app.screen.width);

    p.y = p.y + p.my;
    p.y = Math.ceil(p.y, 0);
    p.y = Math.floor(p.y, app.screen.height);
}

function moveBullet(delta) {
    applyThrust(b, b.r, b.power + bulletSpeedBonus());
    if (b.phase == 0) {
        if (b.y < 0) {
            b.r = getr2(center(b), center(p));
            b.phase = 1;
        }
    } else if (b.phase == 1) {
        if (getDistance(b, p) < 40) {
            b.phase = 0;
            b.r = 90;
        }
        if (b.y + b.height > app.screen.height) {
            b.r -= 180;
            b.phase = 0;
        }
    }
}

app.ticker.add(function(delta) {
    movePlayer();
    moveBullet(delta);
    // p.rotation += 0.01 * delta;  

});
document.body.appendChild(app.view);

</script>